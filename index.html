<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Bot Lite</title>

  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --line: #eaeaea;
      --text: #222;
      --muted: #666;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px 32px; }
    h1 { margin: 0 0 6px; font-size: 28px; }
    p.lead { margin: 0 0 16px; color: var(--muted); }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
    }
    #chat { min-height: 180px; }
    .hidden { display: none; }

    .toolbar { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
    .toolbar button, button, .pill {
      appearance: none; border: 1px solid var(--line); background: #fff; color: var(--text);
      padding: 8px 10px; border-radius: 10px; cursor: pointer; font: inherit;
    }
    .pill { background: #f6f6f6; }

    .row { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }

    textarea {
      width: 100%; height: 110px; resize: vertical;
      padding: 10px 12px; border-radius: 10px; border: 1px solid var(--line); background: #fff;
      font: inherit; line-height: 1.4;
    }

    /* Chat bubbles */
    .bubble { margin: 6px 0; }
    .bubble b { color: #111; }
    .bubble i { color: var(--muted); }

    /* Rendered markdown box */
    #render { margin-top: 8px; }
    #render h1, #render h2, #render h3 { margin: 12px 0 6px; }
    #render ul { padding-left: 20px; }
    #render code, #render pre {
      background: #f4f4f4; border: 1px solid var(--line); border-radius: 8px;
      padding: 8px; overflow: auto;
    }
    #render pre { padding: 12px; }

    /* CSV collapsible */
    #render details.csv-wrap {
      margin-top: 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
    }
    #render details.csv-wrap summary {
      cursor: pointer;
      font-weight: 600;
      margin: 0 0 4px;
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Meal Bot Lite</h1>
    <p class="lead">Click <b>Start intake</b>. Answer the questions. When ready, type <i>make my plan</i>.</p>

    <!-- Chat (Q&A log) -->
    <div id="chat" class="card"></div>

    <!-- Actions -->
    <div class="toolbar">
      <button id="copy">Copy</button>
      <button id="downloadTxt">Download .txt</button>
      <button id="downloadPdf">Download PDF</button>
      <button id="toggleChat">Hide questions</button>
      <button id="copyCsv">Copy CSV</button>
    </div>

    <!-- Rendered plan (Markdown → HTML) -->
    <div id="render" class="card"></div>

    <!-- Quick templates -->
    <div id="templates" class="row">
      <button id="start">Start intake</button>
      <button class="pill" data-t="3day">+ 3-Day Plan</button>
      <button class="pill" data-t="bento">+ Bento Lunches</button>
      <button class="pill" data-t="budget">+ Tight Budget</button>
      <button class="pill" data-t="batch">+ Batch-Prep (Cook Once)</button>
    </div>

    <!-- Input -->
    <textarea id="input" placeholder="Type your answer or ask anything…"></textarea>
    <div class="row"><button id="send">Send</button></div>
  </div>

  <script>
    // --- DOM refs ---
    const chatDiv   = document.getElementById("chat");
    const renderDiv = document.getElementById("render");
    const input     = document.getElementById("input");
    const sendBtn   = document.getElementById("send");
    const startBtn  = document.getElementById("start");
    const templatesRow = document.getElementById("templates");

    // --- Quick templates ---
    const templates = {
      "3day":  "I want a 3-day plan.",
      "bento": "Please include bento-style lunches.",
      "budget":"My budget is tight—favor pantry-first and Costco/Walmart swaps.",
      "batch": "Yes—use Cook Once, Eat All Week style. I have 90 minutes for batch-prep. Flavor families: Mediterranean and BBQ."
    };

    // --- Chat state ---
    let messages = [];

    function add(role, content) {
      const el = document.createElement("div");
      el.className = "bubble";
      el.innerHTML = `<b>${role === "user" ? "You" : "Bot"}:</b> ${content}`;
      chatDiv.appendChild(el);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Start intake
    startBtn.onclick = async () => {
      messages = [{ role: "user", content: "Start intake" }];
      add("user", "Start intake");
      await sendToAPI();
    };

    // Template pills
    templatesRow.addEventListener("click", (e) => {
      if (e.target.dataset && e.target.dataset.t) {
        input.value = templates[e.target.dataset.t] || "";
        input.focus();
      }
    });

    // Send user message
    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;
      messages.push({ role: "user", content: text });
      add("user", text);
      input.value = "";
      await sendToAPI();
    };

    // Server call with message history
    async function sendToAPI() {
      add("assistant", "<i>Thinking…</i>");
      try {
        const r = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });
        const data = await r.json();

        // remove "Thinking…"
        chatDiv.lastChild.remove();

        const md = data.reply || "No reply";

        // Keep chat tidy
        add("assistant", "Plan ready below. (You can show/hide questions)");
        messages.push({ role: "assistant", content: md });

        // Render the plan
        renderDiv.innerHTML = marked.parse(md);

        // Hide the Q&A by default once plan is ready
        chatDiv.classList.add("hidden");
        document.getElementById("toggleChat").textContent = "Show questions";

        // Enhance (collapse CSV, etc.)
        enhanceRendered(md);

      } catch (err) {
        chatDiv.lastChild.remove();
        add("assistant", "I’m at capacity—please try again.");
      }
    }

    // Enhance the rendered markdown (wrap CSV in a collapsible)
    function enhanceRendered(md) {
      const codes = renderDiv.querySelectorAll("pre > code");
      for (const code of codes) {
        const text = code.innerText.trim();
        // Our CSV block starts with "Meal, Day"
        if (/^Meal\s*,\s*Day/i.test(text)) {
          const pre = code.parentElement;
          if (pre.parentElement.tagName.toLowerCase() === "details") break;

          const details = document.createElement("details");
          details.className = "csv-wrap";
          details.open = false;

          const summary = document.createElement("summary");
          summary.textContent = "CSV (copy/paste)";

          pre.replaceWith(details);
          details.appendChild(summary);
          details.appendChild(pre);

          // store for Copy CSV button
          details.dataset.csv = text;
          renderDiv.dataset.csvFound = "1";
          break;
        }
      }
    }

    // ---- Toolbar actions ----
    document.getElementById("copy").onclick = async () => {
      const txt = renderDiv.innerText;
      await navigator.clipboard.writeText(txt);
      alert("Copied!");
    };

    document.getElementById("downloadTxt").onclick = () => {
      const txt  = renderDiv.innerText;
      const blob = new Blob([txt], { type: "text/plain" });
      const url  = URL.createObjectURL(blob);
      const a    = Object.assign(document.createElement("a"), { href: url, download: "meal-plan.txt" });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    // Better PDF formatting (detect headings)
    document.getElementById("downloadPdf").onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc   = new jsPDF({ unit: "pt", format: "letter" });
      const lines = renderDiv.innerText.split("\n");

      const left = 36, topStart = 48, maxWidth = 540;
      let y = topStart;

      for (let raw of lines) {
        let text = raw.trimRight();
        if (!text) { y += 8; continue; }

        let size = 11, gapBefore = 4, gapAfter = 6;
        if (text.startsWith("# "))   { size = 18; gapBefore = 10; gapAfter = 10; text = text.replace(/^#\s+/, ""); }
        else if (text.startsWith("## "))  { size = 15; gapBefore = 8; gapAfter = 8; text = text.replace(/^##\s+/, ""); }
        else if (text.startsWith("### ")) { size = 13; gapBefore = 6; gapAfter = 6; text = text.replace(/^###\s+/, ""); }

        y += gapBefore;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(size);

        const chunks = doc.splitTextToSize(text, maxWidth);
        for (const cl of chunks) {
          if (y > doc.internal.pageSize.getHeight() - 48) { doc.addPage(); y = topStart; }
          doc.text(cl, left, y);
          y += size + 3;
        }
        y += gapAfter;
      }
      doc.save("meal-plan.pdf");
    };

    // Toggle questions visibility
    document.getElementById("toggleChat").onclick = () => {
      const btn = document.getElementById("toggleChat");
      if (chatDiv.classList.contains("hidden")) {
        chatDiv.classList.remove("hidden");
        btn.textContent = "Hide questions";
      } else {
        chatDiv.classList.add("hidden");
        btn.textContent = "Show questions";
      }
    };

    // Copy only the CSV block
    document.getElementById("copyCsv").onclick = async () => {
      const csvDetails = renderDiv.querySelector("details.csv-wrap");
      let csv = csvDetails?.dataset.csv || "";
      if (!csv) {
        const codes = renderDiv.querySelectorAll("pre > code");
        for (const code of codes) {
          const t = code.innerText.trim();
          if (/^Meal\s*,\s*Day/i.test(t)) { csv = t; break; }
        }
      }
      if (!csv) return alert("No CSV found yet.");
      await navigator.clipboard.writeText(csv);
      alert("CSV copied!");
    };
  </script>
</body>
</html>
