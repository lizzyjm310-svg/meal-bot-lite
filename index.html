<body>
  <div style="font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px;">
    <h1 style="margin:0 0 8px;">Meal Bot Lite</h1>
    <p style="margin-top:0;">Click <b>Start intake</b>. Answer the questions. When ready, type <i>make my plan</i>.</p>

    <div id="chat" style="border:1px solid #eee;border-radius:10px;padding:12px;min-height:180px;background:#fafafa;"></div>

    <div style="display:flex;gap:8px;margin:12px 0;">
      <button id="start">Start intake</button>
      <button data-t="3day">+ 3-Day Plan</button>
      <button data-t="bento">+ Bento Lunches</button>
      <button data-t="budget">+ Tight Budget</button>
    </div>

    <textarea id="input" placeholder="Type your answer…" style="width:100%;height:110px;"></textarea>
    <br />
    <button id="send">Send</button>
  </div>

  <script>
    const chatDiv = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const startBtn = document.getElementById("start");
    const templatesBar = document.querySelector('[data-t]')?.parentElement;

    const templates = {
      "3day": "I want a 3-day plan.",
      "bento": "Please include bento-style lunches.",
      "budget": "My budget is tight—favor pantry-first and Costco/Walmart swaps."
    };

    let messages = [];

    function add(role, content) {
      const el = document.createElement("div");
      el.style.margin = "6px 0";
      el.innerHTML = `<b>${role === "user" ? "You" : "Bot"}:</b> ${content}`;
      chatDiv.appendChild(el);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    startBtn.onclick = async () => {
      messages = [{ role: "user", content: "Start intake" }];
      add("user", "Start intake");
      await sendToAPI();
    };

    if (templatesBar) {
      templatesBar.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON" && e.target.dataset.t) {
          input.value = templates[e.target.dataset.t];
          input.focus();
        }
      });
    }

    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;
      messages.push({ role: "user", content: text });
      add("user", text);
      input.value = "";
      await sendToAPI();
    };

    async function sendToAPI() {
      add("assistant", "<i>Thinking…</i>");
      try {
        const r = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages }),
        });
        const data = await r.json();
        chatDiv.lastChild.remove(); // remove Thinking…
        add("assistant", data.reply || "No reply");
        messages.push({ role: "assistant", content: data.reply || "" });
      } catch {
        chatDiv.lastChild.remove();
        add("assistant", "I’m at capacity—please try again.");
      }
    }
  </script>
</body>
